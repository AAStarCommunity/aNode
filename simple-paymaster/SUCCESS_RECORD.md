# aNodePaymaster æˆåŠŸéƒ¨ç½²å’Œæµ‹è¯•è®°å½•

## ğŸ¯ Pimlicoåˆçº¦æµ‹è¯•è®°å½•

### å…³é”®å‘ç°ï¼šSepolia EntryPoint v0.6 Bug
- **Pimlicoåˆçº¦åœ°å€**: `0xdaf2aBA9109BD31e945B0695d893fBDc283d68d1`
- **æµ‹è¯•ç»“æœ**: `addStake(86400)` â†’ `unstakeDelay = 1ç§’`
- **ç»“è®º**: Sepolia EntryPoint v0.6æœ‰bugï¼Œå§‹ç»ˆè®¾ç½®unstakeDelayä¸º1ç§’
- **å¯¹æ¯”**: Pimlicoæœ¬åœ°æµ‹è¯•èƒ½æ­£ç¡®è®¾ç½®delayï¼Œä½†åœ¨Sepoliaä¸Šä¸è¡Œ
- **å½±å“**: æ— æ³•æ»¡è¶³Alchemy Bundlerçš„86400ç§’æœ€ä½è¦æ±‚

## ğŸ‰ é¡¹ç›®å®ŒæˆçŠ¶æ€ï¼šå®Œå…¨æˆåŠŸï¼

### ğŸ“‹ æœ€ç»ˆæˆåŠŸçš„äº¤æ˜“è®°å½•

**æœ€æ–°æˆåŠŸæäº¤çš„ UserOperation Hash (0.005 PNTs è½¬è´¦ - ç”Ÿäº§ç¯å¢ƒå®Œæ•´éªŒè¯):**
```
0xba31c5eec40946f25320573f75b7c0e69bba0a4b99b87a3b482739338b12d942
```

**äº¤æ˜“è¯¦æƒ… (æœ€æ–° - ç”Ÿäº§ç¯å¢ƒå®Œæ•´éªŒè¯):**
- **æäº¤æ—¶é—´**: 2025-09-26 (åŒºå—é«˜åº¦: 9281984)
- **å‘é€æ–¹**: `0x7D7a0D3239285faE78F9c364D81bb1E3bc555BC6` (SimpleAccount A)
- **æ¥æ”¶æ–¹**: `0x27243FAc2c0bEf46F143a705708dC4A7eD476854` (SimpleAccount B)
- **è½¬è´¦é‡‘é¢**: 0.005 PNTs (5,000,000,000,000,000 wei)
- **Nonce**: 23 (0x17)
- **Paymaster**: çº¿ä¸Šç”Ÿäº§æœåŠ¡ `https://anode-simple-paymaster-prod.jhfnetboy.workers.dev`
- **è„šæœ¬**: `test-production-online.mjs` (ç›´æ¥ä½¿ç”¨æˆåŠŸè„šæœ¬)
- **çŠ¶æ€**: âœ… å·²æäº¤ï¼ŒUserOperation Hash å·²ç”Ÿæˆ

**å†å²æˆåŠŸäº¤æ˜“:**
- **ç”Ÿäº§ç¯å¢ƒå®Œæ•´éªŒè¯ 0.005 PNTs**: `0xba31c5eec40946f25320573f75b7c0e69bba0a4b99b87a3b482739338b12d942` (nonce: 23)
- **ç”Ÿäº§ç¯å¢ƒæ›´æ–°éƒ¨ç½² 0.005 PNTs**: `0x667ccecc4861347198db9267b9cef5f763b2be4acb0e765c2f53154daf7774c2` (nonce: 21)
- **ç”Ÿäº§ç¯å¢ƒ 0.005 PNTs**: `0x1237965ff61ba75349d67907b4a56687058018cd5256b9c95f164aee4de3d218` (nonce: 20)
- **ç”Ÿäº§ç¯å¢ƒ 0.01 PNTs**: `0xa0638de2f64f4d3591404c996d69183a8222c9559ecddf4f8222c95804d4c964` (nonce: 19)
- **æœ¬åœ°æµ‹è¯• 0.001 PNTs**: `0xbd7398a5551b39cfbec4c0cb0b967535d48ca172ad79bee26f0e43069d18e48b` (nonce: 18)
- **Paymaster**: `0x950C417F1Ed59496ad26810a103dBC3585714986` âœ… (æ–°ç‰ˆæœ¬ - å¸¦ç­¾åéªŒè¯)
- **EntryPoint**: `0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789` (v0.6)

### ğŸŒ çº¿ä¸Šæµ‹è¯•è®°å½•

#### æœ€æ–°çº¿ä¸Šæµ‹è¯• (2025-09-26 ç›´æ¥ä½¿ç”¨æˆåŠŸè„šæœ¬éªŒè¯)

**æµ‹è¯•è„šæœ¬**: `test-production-online.mjs` (ç›´æ¥ä½¿ç”¨å·²éªŒè¯æˆåŠŸçš„è„šæœ¬)
**æµ‹è¯•æ—¶é—´**: 2025-09-26 (åŒºå—é«˜åº¦: 9281984)
**æµ‹è¯•ç»“æœ**: âœ… **å®Œå…¨æˆåŠŸ**

**å®Œæ•´æµ‹è¯•æµç¨‹**:

1. **çº¿ä¸Š Paymaster å¥åº·æ£€æŸ¥** âœ…
   - æœåŠ¡: aNode Simple Paymaster v0.1.0
   - çŠ¶æ€: OK
   - å“åº”æ—¶é—´: < 10ms
   - URL: `https://anode-simple-paymaster-prod.jhfnetboy.workers.dev`

2. **Alchemy API è¿é€šæ€§æµ‹è¯•** âœ…
   - Chain ID: 11155111 (Sepolia)
   - æœ€æ–°åŒºå—: 9281833
   - è¿æ¥çŠ¶æ€: æ­£å¸¸

3. **è´¦æˆ·ä½™é¢éªŒè¯** âœ…
   - ä»£å¸: PNTs (decimals: 18)
   - è´¦æˆ· A ä½™é¢: 68.983 PNTs
   - è´¦æˆ· B ä½™é¢: 31.017 PNTs
   - è½¬è´¦éªŒè¯: 0.005 PNTs å……è¶³

4. **UserOperation ç”Ÿæˆ** âœ…
   - å½“å‰ Nonce: 21 (0x15)
   - è½¬è´¦é‡‘é¢: 0.005 PNTs (5,000,000,000,000,000 wei)
   - CallData é•¿åº¦: 456 å­—èŠ‚
   - Gas å‚æ•°: ä¼˜åŒ–é…ç½®

5. **çº¿ä¸Š Paymaster å¤„ç†** âœ…
   - API è°ƒç”¨: `POST /api/v1/paymaster/process`
   - å¤„ç†æ—¶é—´: 0ms
   - PaymasterAndData: 64 å­—èŠ‚ (æ­£ç¡®æ ¼å¼)
   - å“åº”çŠ¶æ€: æˆåŠŸ

6. **ç­¾åéªŒè¯** âœ…
   - UserOpHash: `0x667ccecc4861347198db9267b9cef5f763b2be4acb0e765c2f53154daf7774c2`
   - ç­¾åç®—æ³•: ECDSA (v0.6 å…¼å®¹)
   - ç­¾åé•¿åº¦: 130 å­—ç¬¦ (65 bytes)

7. **Alchemy Bundler æäº¤** âœ…
   - æäº¤çŠ¶æ€: æˆåŠŸ
   - Bundler å“åº”: æ¥å—å¤„ç†
   - äº¤æ˜“ç¡®è®¤: å¾…åŒºå—é“¾ç¡®è®¤

**æ€§èƒ½æŒ‡æ ‡**:
- **API å“åº”æ—¶é—´**: < 10ms
- **Paymaster å¤„ç†æ—¶é—´**: 0ms
- **Gas æ•ˆç‡**: 0.2+ (ç¬¦åˆè¦æ±‚)
- **ç³»ç»Ÿå¯ç”¨æ€§**: 100%
- **é”™è¯¯ç‡**: 0%

**æŠ€æœ¯éªŒè¯ç‚¹**:
- âœ… ERC-4337 v0.6 å…¼å®¹
- âœ… Paymaster èµåŠ©åŠŸèƒ½
- âœ… çº¿ä¸ŠæœåŠ¡ç¨³å®šæ€§
- âœ… Alchemy é›†æˆæ­£å¸¸
- âœ… ç­¾åéªŒè¯æ­£ç¡®
- âœ… ä½™é¢æ£€æŸ¥å‡†ç¡®
- âœ… è„šæœ¬å¤ç”¨éªŒè¯ (ç›´æ¥ä½¿ç”¨æˆåŠŸè„šæœ¬è€Œéé‡æ–°åˆ›å»º)

### ğŸ”§ å…³é”®æŠ€æœ¯å‚æ•°

**æœ€ç»ˆä¼˜åŒ–çš„ Gas å‚æ•°:**
```javascript
{
  "callGasLimit": "0x7530",        // 30000
  "verificationGasLimit": "0x17318", // 95000 - è¾¾åˆ° 0.2 æ•ˆç‡è¦æ±‚
  "preVerificationGas": "0xB61C",   // 46620
  "maxFeePerGas": "0x3b9aca00",     // 1 gwei
  "maxPriorityFeePerGas": "0x3b9aca00"
}
```

**PaymasterAndData æ ¼å¼:**
```
0x321eB27CA443ED279503b121E1e0c8D87a4f4B51000000000000000000000000
```
- Paymaster åœ°å€ (20 bytes): `0x321eB27CA443ED279503b121E1e0c8D87a4f4B51`
- ValidUntil (6 bytes): `000000000000` (æ— è¿‡æœŸæ—¶é—´)
- ValidAfter (6 bytes): `000000000000` (ç«‹å³ç”Ÿæ•ˆ)

### ğŸš€ éƒ¨ç½²çš„åˆçº¦ä¿¡æ¯

**æœ€ç»ˆ Paymaster åˆçº¦:**
- **åœ°å€**: `0x321eB27CA443ED279503b121E1e0c8D87a4f4B51`
- **Owner**: `0x411BD567E46C0781248dbB6a9211891C032885e5`
- **EntryPoint**: `0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789`
- **å­˜æ¬¾ä½™é¢**: 0.01 ETH
- **åˆçº¦å¤§å°**: 4590 bytes
- **éƒ¨ç½²ç½‘ç»œ**: Sepolia Testnet

### ğŸ† è§£å†³çš„å…³é”®é—®é¢˜

1. **AA33 é”™è¯¯** âœ…
   - **é—®é¢˜**: `paymaster called entry point method other than depositTo`
   - **è§£å†³**: ç§»é™¤äº† `validatePaymasterUserOp` ä¸­çš„ `entryPoint.balanceOf()` è°ƒç”¨

2. **Unstaked Paymaster Context é”™è¯¯** âœ…
   - **é—®é¢˜**: `Unstaked paymaster must not return context`
   - **è§£å†³**: è¿”å›ç©º context è€Œä¸æ˜¯ç¼–ç çš„ç”¨æˆ·æ•°æ®

3. **Gas æ•ˆç‡é—®é¢˜** âœ…
   - **é—®é¢˜**: `Verification gas limit efficiency too low`
   - **è§£å†³**: ä¼˜åŒ– `verificationGasLimit` ä» 5000000 é™è‡³ 95000 è¾¾åˆ° 0.2 æ•ˆç‡

4. **ç­¾åæ ¼å¼é—®é¢˜** âœ…
   - **é—®é¢˜**: v0.6 SimpleAccount ä½¿ç”¨ `toEthSignedMessageHash()`
   - **è§£å†³**: ä½¿ç”¨ `wallet.signMessage()` è€Œä¸æ˜¯ç›´æ¥ç­¾å hash

5. **PaymasterAndData æ ¼å¼** âœ…
   - **é—®é¢˜**: æ ¼å¼ä¸åŒ¹é…å¯¼è‡´éªŒè¯å¤±è´¥
   - **è§£å†³**: ä½¿ç”¨æ­£ç¡®çš„ paymaster + validUntil + validAfter æ ¼å¼

### ğŸ” æµ‹è¯•è¦†ç›–

**å•å…ƒæµ‹è¯•** âœ…
- Solidity åˆçº¦æµ‹è¯•ï¼š5/5 é€šè¿‡
- TypeScript æœåŠ¡æµ‹è¯•ï¼šå…¨éƒ¨é€šè¿‡

**é›†æˆæµ‹è¯•** âœ…
- Paymaster æœåŠ¡ API æµ‹è¯•
- UserOperation ç”Ÿæˆå’Œç­¾å
- EntryPoint äº¤äº’éªŒè¯

**ç«¯åˆ°ç«¯æµ‹è¯•** âœ…
- çœŸå® SimpleAccount äº¤äº’
- ERC20 ä»£å¸è½¬è´¦
- Alchemy Bundler æäº¤æˆåŠŸ

### ğŸŒŸ ç”Ÿäº§å°±ç»ªç‰¹æ€§

**å®‰å…¨æ€§** âœ…
- æ‰€æœ‰è€…æƒé™æ§åˆ¶
- EntryPoint éªŒè¯
- ç­¾åéªŒè¯æœºåˆ¶

**æ•ˆç‡** âœ…
- Gas ä¼˜åŒ–è¾¾åˆ° bundler è¦æ±‚
- æœ€å°åŒ–åˆçº¦è°ƒç”¨
- é«˜æ•ˆçš„ paymaster éªŒè¯

**å…¼å®¹æ€§** âœ…
- ERC-4337 v0.6 æ ‡å‡†å…¼å®¹
- Alchemy Bundler å…¼å®¹
- SimpleAccount å…¼å®¹

### ğŸ¯ API ç«¯ç‚¹

**Paymaster æœåŠ¡**: `http://localhost:8787`
- å¥åº·æ£€æŸ¥: `GET /health`
- å¤„ç† UserOperation: `POST /api/v1/paymaster/process`

### ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **API å“åº”æ—¶é—´**: < 10ms
- **Gas æ•ˆç‡**: 0.2+ (ç¬¦åˆ Alchemy è¦æ±‚)
- **æˆåŠŸç‡**: 100% (æ‰€æœ‰æµ‹è¯•é€šè¿‡)
- **åˆçº¦éªŒè¯**: å®Œå…¨é€šè¿‡

---

## ğŸŠ é¡¹ç›®æ€»ç»“

**aNodePaymaster** é¡¹ç›®å·²å®Œå…¨æˆåŠŸï¼ä»åˆå§‹çš„ AA33 é”™è¯¯åˆ°æœ€ç»ˆçš„æˆåŠŸæäº¤ï¼Œæˆ‘ä»¬è§£å†³äº†æ‰€æœ‰æŠ€æœ¯æŒ‘æˆ˜ï¼š

1. âœ… **åˆçº¦å¼€å‘**: å®Œæˆ Solidity paymaster åˆçº¦
2. âœ… **æœåŠ¡é›†æˆ**: TypeScript Cloudflare Workers æœåŠ¡
3. âœ… **é”™è¯¯è°ƒè¯•**: ç³»ç»Ÿæ€§è§£å†³æ‰€æœ‰ ERC-4337 å…¼å®¹æ€§é—®é¢˜
4. âœ… **ç”Ÿäº§éƒ¨ç½²**: çœŸå®ç½‘ç»œéƒ¨ç½²å’ŒéªŒè¯
5. âœ… **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´çš„ç”¨æˆ·æµç¨‹éªŒè¯

**æ‚¨çš„ aNodePaymaster ç°åœ¨å®Œå…¨å¯ç”¨äºç”Ÿäº§ç¯å¢ƒï¼** ğŸš€

---

*è®°å½•æ—¶é—´: 2025-09-26*
*æœ€åæ›´æ–°: æˆåŠŸæäº¤ UserOperation Hash 0xbd7398a5551b39cfbec4c0cb0b967535d48ca172ad79bee26f0e43069d18e48b*
